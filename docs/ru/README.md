<p align="right"><a href="README.md">English</a> | Русский</p>


## Клиент WireGuard для роутеров на прошивке Padavan

Один исполняемый файл, требующий для работы только стандартный файл конфигурации WireGuard.


### Необходимые условия

1. Прошивка с поддержкой WireGuard.  
    Например [padavan-ng от Алексея](https://gitlab.com/dm38/padavan-ng), установленная и работающая на роутере

1. Возможность выполнять команды на роутере.  
    Предпочтительнее через SSH, но можно и в веб-интерфейсе роутера.

    <details>
      <summary>Подробнее</summary>

      Включите SSH сервер в веб-интерфейсе роутера: **Администрирование** → **Сервисы** → **Включить SSH-сервер?** → **Да**

      Для доступа по SSH используются те же данные, что и для входа в веб-интерфейс.

      В Linux, Mac OS и Windows 10+ SSH клиент обычно предустановлен, просто откройте терминал и выполните подключение:

      ```sh
      ssh admin@192.168.1.1
      ```

      В более старых версиях Windows можно использовать [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty), [Tabby](https://tabby.sh) или [другие SSH клиенты](https://alternativeto.net/software/putty/?feature=ssh-client&license=free&platform=windows).

      При установленном SSH клиенте часто можно подключиться, просто перейдя по ссылке

      ```text
      ssh://admin@192.168.1.1
      ```

      Вставьте её в адресную строку браузера вручную и нажмите Enter — GitHub не позволяет делать активные ссылки с нестандартными протоколами.
    </details>

1. Возможность копировать файлы на роутер.  
    Обычно для этого используется SFTP, он работает на базе SSH.

    <details>
      <summary>Подробнее</summary>

      В Windows можно использовать [WinSCP](https://winscp.net), в Mac OS — [Cyberduck](https://cyberduck.io). В Linux поддержка SFTP обычно встроена в ваш файловый менеджер, загляните в раздел "Сеть" или "Другие места".

      Подключиться обычно можно, просто перейдя по ссылке

      ```text
      sftp://admin@192.168.1.1/etc/storage/
      ```

      Вставьте её в адресную строку браузера вручную и нажмите Enter — GitHub не позволяет делать активные ссылки с нестандартными протоколами.
    </details>


### Установка и настройка WireGuard клиента

Я в основном буду использовать команды во избежание неверной интерпретации, но операции с файлами / папками, конечно, можно также выполнить и через SFTP.

1. Если у вас установлена предыдущая версия клиента Wireguard, состоявшая из нескольких `.sh` файлов, её требуется отключить / удалить. Пока можно просто переместить папку с ним, не удаляя:

    ```sh
    mv /etc/storage/wireguard /etc/storage/wireguard.bak
    ```

1. Создайте папку `wireguard` в `/etc/storage` на роутере:

    ```sh
    mkdir /etc/storage/wireguard
    ```

1. Скопируйте в неё файл `client.sh`:

    ```sh
    wget https://github.com/shvchk/padavan-wireguard-client/raw/main/client.sh -O /etc/storage/wireguard/client.sh
    ```

    > [!WARNING]  
    > Рекомендую проверить скрипт [client.sh](client.sh) перед запуском. Это хорошая практика перед запуском любого кода на вашем устройстве, особенно удалённого кода.

1. Сделайте его исполняемым:

    ```sh
    chmod +x /etc/storage/wireguard/client.sh
    ```

1. Скопируйте конфигурацию клиента WireGuard в `/etc/storage/wireguard`

    Имя файла конфигурации будет использовано в качестве имени интерфейса. Например, для файла `wg0.conf` будет создан интерфейс `wg0`.

    > [!IMPORTANT]  
    > Имя должно содержать только латинские буквы, цифры и / или символы `_` `=` `+` `.` `-`, быть короче 16 символов и заканчиваться на `.conf`. В случае наличия нескольких файлов конфигурации, будет использован первый по алфавиту.

1. Запустите клиент WireGuard:

    ```sh
    /etc/storage/wireguard/client.sh start
    ```

1. Проверьте, работает ли интернет на роутере и ваших устройствах:

    ```sh
    ping -c 3 -W 1 1.1.1.1
    ```

1. В случае проблем, выключите клиент WireGuard:

    ```sh
    /etc/storage/wireguard/client.sh stop
    ```

1. После того, как вы убедились, что всё хорошо работает, настройте автозапуск:

    ```sh
    /etc/storage/wireguard/client.sh autostart enable
    ```

1. Сохраните изменения:

    ```sh
    mtd_storage.sh save
    ```

1. Перезагрузите роутер


### Удаление

```sh
/etc/storage/wireguard/client.sh stop
/etc/storage/wireguard/client.sh autostart disable
rm -rf /etc/storage/wireguard
mtd_storage.sh save
```


### Добавление исключений

Исключения можно добавлить в одном из этих файлов:

- `/etc/storage/started_script.sh` (в веб интерфейсе: **Персонализация** → **Скрипты** → **Выполнить после полного запуска маршрутизатора**)

- `/etc/storage/post_iptables_script.sh` (в веб интерфейсе: **Персонализация** → **Скрипты** → **Выполнить после перезапуска правил брандмауэра**)

Сначала добавьте небольшую вспомогательную функцию:

```sh
direct() {
  ip rule del $1 $2 || :
  ip rule add $1 $2 table main pref 30
}
```

Затем её можно использовать так: `direct <to|from> <IP-адрес|подсеть>`. Например:

- Направить напрямую трафик **к** IP 9.9.9.9: `direct to 9.9.9.9`

- Направить напрямую трафик **к** подсети 1.2.0.0/16: `direct to 1.2.0.0/16`

- Направить напрямую трафик **от** IP 192.168.1.11: `direct from 192.168.1.11`

- Направить напрямую трафик **от** подсети 10.11.12.0/24: `direct to 10.11.12.0/24`

Таких правил можно добавить сколько угодно, по одному на строку.

При редактировании через SSH не забудьте записать изменения в постоянную память:

```sh
mtd_storage.sh save
```
